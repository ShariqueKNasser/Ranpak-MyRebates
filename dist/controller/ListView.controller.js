sap.ui.define(["ranpak/wz/rebatelist/controller/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/Token","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/Fragment","sap/m/BusyDialog","sap/ui/table/Column","sap/m/Text","sap/m/DatePicker","sap/m/Input","sap/ui/core/format/NumberFormat","ranpak/wz/rebatelist/model/formatter"],function(e,t,a,l,i,r,s,o,n,d,u,g,c,h){"use strict";return e.extend("ranpak.wz.rebatelist.controller.ListView",{formatter:h,onInit:function(){var e=this.getOwnerComponent();this._router=e.getRouter();this._router.getRoute("ListView").attachPatternMatched(this._handleRouteMatched,this)},_handleRouteMatched:function(e){this.oBusyDialog=new o;this.oI18n=this.getView().getModel("i18n").getResourceBundle();this.oUserEditMdl=this.getOwnerComponent().getModel("oUserEditMdl");this.oBlkUpldMdl=this.getOwnerComponent().getModel("oBlkUpldMdl");this.oFiltrKeys=["RebateID","ValidTo","CustomerID","EndUserID","MaterialID","Status"];this.oClmSbmsnDt=[];this.oFinalMsgArr=[];this.oFileUploaded=false;this.resetAttachMdl();const t=function(e){const t=e.text;return new l({key:t,text:t})};this.byId("inputRebateID").addValidator(t);var a=new Date;var i=new Date((new Date).setDate(a.getDate()-60));this.oUserEditMdl.setProperty("/maxDate",new Date);this.oUserEditMdl.setProperty("/minDate",i)},onFilterClear:function(e){var t=this.getView().byId("idMyRebatesFB");var a="";for(var l=0;l<this.oFiltrKeys.length;l++){a=t.getControlByKey(this.oFiltrKeys[l]);if(this.oFiltrKeys[l]==="RebateID"){a.setTokens([])}else if(this.oFiltrKeys[l]==="ValidTo"){a.setValue(null)}else if(this.oFiltrKeys[l]==="Status"){a.setSelectedKey(null)}else{a.setSelectedKeys([])}}var i=this.getView().byId("idMyRebatesPg");var r=this.getView().byId("idMyRebatesTbl");var s=r.getTable().getSelectedItems();this.onTblMutliDSlct(i,s);t.fireSearch();this.resetAttachMdl()},onBeforeRebindTbl:function(e){var i=this.getView().byId("idMyRebatesFB");var r=e.getParameter("bindingParams");var s=r.parameters.select;s+=",MaterialDescription,EndUserDescription,CustomerDescription,Currency";r.parameters.select=s;var o=i.getAllFiltersWithValues();for(var n=0;n<o.length;n++){this.formFiltersForTable(r,i,o[n])}const d=new sap.ui.core.routing.HashChanger;let u=d.getHash();if(u){u=u.split("SearchString=")[1];if(!u){return}const e=new t("RebateID",a.Contains,u);const i=new t("CustomerDescription",a.Contains,u);const s=new t("CustomerID",a.Contains,u);const o=new t([e,i,s],false);r.filters.push(o);this.byId("inputRebateID").setTokens([new l({key:u,text:u})])}},formFiltersForTable:function(e,t,a){var l=a.getName();var i=t.getControlByKey(l);var r="",s="";switch(l){case"RebateID":r=i.getTokens();s=this.formMultiFiltrMdl(r,"RebateID",true);break;case"CustomerID":r=i.getSelectedKeys();s=this.formMultiFiltrMdl(r,"CustomerID",true);break;case"ValidTo":r=i.getDateValue();s=this.formMultiFiltrMdl(r,"ValidTo",false,i);break;case"EndUserID":r=i.getSelectedKeys();s=this.formMultiFiltrMdl(r,"EndUserID",true);break;case"MaterialID":r=i.getSelectedKeys();s=this.formMultiFiltrMdl(r,"MaterialID",true);break;case"Status":r=i.getSelectedKey();s=this.formMultiFiltrMdl(r,"Status",false);break;default:break}e.filters.push(s)},formMultiFiltrMdl:function(e,a,l,i){var r=[],s="",o="",n="",d="EQ";if(l){for(var u=0;u<e.length;u++){if(a==="RebateID"){d="EQ";o=e[u].getText()}else{o=e[u].toUpperCase()}}}else{if(a==="ValidTo"){d="BT";o=this.fetchDate(i.getDateValue());n=new Date(i.getSecondDateValue().getFullYear(),i.getSecondDateValue().getMonth()+1,0);n=this.fetchDate(n)}else if(a==="Status"){o=e}}s=new t({path:a,operator:d,value1:o,value2:n});r.push(s);return new t(r)},onBeforeVariantFetch:function(e){var t=this.getView().byId("idMyRebatesFB");var a=[];var l=t.getControlByKey("RebateID").getTokens();for(var i=0;i<l.length;i++){a.push(l[i].getText())}t.setFilterData({_CUSTOM:{RebateID:a,ValidTo:t.getControlByKey("ValidTo").getValue(),CustomerID:t.getControlByKey("CustomerID").getSelectedKeys(),EndUserID:t.getControlByKey("EndUserID").getSelectedKeys(),MaterialID:t.getControlByKey("MaterialID").getSelectedKeys(),Status:t.getControlByKey("Status").getSelectedKey()}})},onVariantLoad:function(e){var t=this.getView().byId("idMyRebatesFB");var a=t.getFilterData();var i=a["_CUSTOM"];var r=[];for(var s=0;s<i.RebateID.length;s++){r.push(new l({key:i.RebateID[s],text:i.RebateID[s]}));t.getControlByKey("RebateID").setTokens(r)}t.getControlByKey("CustomerID").setSelectedKeys(i.CustomerID);t.getControlByKey("EndUserID").setSelectedKeys(i.EndUserID);t.getControlByKey("MaterialID").setSelectedKeys(i.MaterialID);t.getControlByKey("ValidTo").setValue(i.ValidTo);t.getControlByKey("Status").setSelectedKey(i.Status)},onMyRebatesExport:function(e){var t="";t="My_Rebates_"+(new Date).toISOString();e.getParameter("exportSettings").fileName=t;this.formatExportList(e)},formatExportList:function(e){var t=e.getParameter("exportSettings").workbook;var a=t.columns;t.context={sheetName:"My Rebates"};for(var l=0;l<a.length;l++){switch(a[l].label){case this.oI18n.getText("columnCustomer"):a[l].property=["CustomerDescription","CustomerID"];a[l].template="{0} ({1})";break;case this.oI18n.getText("columnRebateID"):a[l].property="RebateID";break;case this.oI18n.getText("columnEndUser"):a[l].property=["EndUserDescription","EndUserID"];a[l].template="{0} ({1})";break;case this.oI18n.getText("columnMaterial"):a[l].property=["MaterialDescription","MaterialID"];a[l].template="{0} ({1})";break;case this.oI18n.getText("columnUnit"):a[l].property="Unit";break;case this.oI18n.getText("columnListPrice"):a[l].property="ListPrice";break;case this.oI18n.getText("columnRebateAmount"):a[l].property="RebateAmount";break;case this.oI18n.getText("columnNetPrice"):a[l].property="NetPrice";break;case this.oI18n.getText("columnValidFrom"):a[l].type=sap.ui.export.EdmType.Date;a[l].property="ValidFrom";a[l].format="YYYY/MM/dd";break;case this.oI18n.getText("columnValidTo"):a[l].type=sap.ui.export.EdmType.Date;a[l].property="ValidTo";a[l].format="YYYY/MM/dd";break;case this.oI18n.getText("columnStatus"):a[l].property="Status";break;case this.oI18n.getText("columnEndUserPrice"):a[l].property="EndUserPrice";break;default:break}}},GetStatusState:function(e){if(e===this.oI18n.getText("filterStatusActive")){return"Success"}if(e===this.oI18n.getText("filterStatusExpired")){return"Error"}},onTblMutliDSlct:function(e,t,a){var l,i;for(var r=0;r<t.length;r++){t[r].setSelected(false);l=t[r].getCells();for(var s=0;s<l.length;s++){i=l[s].getCustomData();if(i.length>0){if(i[0].getKey()==="INVOICE_NO"||i[0].getKey()==="SHIP_DATE"||i[0].getKey()==="QUANTITY_SOLD"){l[s].setVisible(false);l[s].setValue(null)}}}}e.setShowFooter(false);this.oClmSbmsnDt=[];this.oUserEditMdl.setProperty("/claimSubmissionData",this.oClmSbmsnDt);this.oUserEditMdl.refresh(true)},onTblItmSnglSlctn:function(e,t,a,l,r,s,o){var n;if(a==="Expired"){i.show(this.oI18n.getText("INVALID_ITEM_SELECT"));e.setSelected(false)}else{for(var d=0;d<t.length;d++){n=t[d].getCustomData();if(n.length>0){if(n[0].getKey()==="INVOICE_NO"||n[0].getKey()==="SHIP_DATE"||n[0].getKey()==="QUANTITY_SOLD"){if(l){t[d].setVisible(true)}else{t[d].setVisible(false)}}}}if(r.length===0){s.setShowFooter(false)}else{if(!s.getShowFooter()){s.setShowFooter(true)}this.formClmSubmsnDt(o,l)}}},onTblItmSlct:function(e){var t=this.getView().byId("idMyRebatesPg");var a=e.getParameter("listItems");if(a.length>1){this.onTblMutliDSlct(t,a)}else{var l=this.getView().byId("idMyRebatesTbl");var i=l.getTable().getSelectedItems();var r=e.getParameter("listItem");var s=r.getBindingContext().getObject();var o=s.Status;var n=r.getCells();var d=e.getParameter("selected");this.onTblItmSnglSlctn(r,n,o,d,i,t,s)}},formClmSubmsnDt:function(e,t){e.End_User_Invoice="";e.End_User_Ship_Date="";e.Quantity="";if(t){this.oClmSbmsnDt.push(e)}else{for(var a=0;a<this.oClmSbmsnDt.length;a++){if(e.ID===this.oClmSbmsnDt[a].ID){this.oClmSbmsnDt.splice(a)}}}this.oUserEditMdl.setProperty("/claimSubmissionData",this.oClmSbmsnDt);this.oUserEditMdl.refresh(true)},onClmFldEdit:function(e){var t=e.getSource().getCustomData()[0].getKey();var a=e.getSource().getBindingContext().getObject();for(var l=0;l<this.oClmSbmsnDt.length;l++){if(a.ID===this.oClmSbmsnDt[l].ID){if(t==="INVOICE_NO"){var r=this.validateAlphaNumFld(e);if(r){e.getSource().setValueState("None");this.oClmSbmsnDt[l].End_User_Invoice=e.getSource().getValue()}else{i.show(this.oI18n.getText("INVALID_ENTRY"));e.getSource().setValueState("Error");e.getSource().setValue(null)}}else if(t==="SHIP_DATE"){this.oClmSbmsnDt[l].End_User_Ship_Date=e.getSource().getValue()}else if(t==="QUANTITY_SOLD"){var s=this.validateNumberFld(e);if(s){e.getSource().setValueState("None");this.oClmSbmsnDt[l].Quantity=e.getSource().getValue()}else{i.show(this.oI18n.getText("INVALID_ENTRY"));e.getSource().setValueState("Error");e.getSource().setValue(null)}}}}this.oUserEditMdl.setProperty("/claimSubmissionData",this.oClmSbmsnDt);this.oUserEditMdl.refresh(true)},validatePayload:function(){var e=1;var t=this.getView().byId("idMyRebatesTbl");var a=t.getTable().getSelectedItems();var l,i,r;for(var o=0;o<a.length;o++){l=a[o].getCells();for(var n=0;n<l.length;n++){i=l[n].getCustomData();if(i.length>0){r=i[0].getKey();if(r==="INVOICE_NO"||r==="SHIP_DATE"||r==="QUANTITY_SOLD"){if(!l[n].getValue()){l[n].setValueState("Error");e=0}else{l[n].setValueState("None")}}}}}if(e===1){this.oBusyDialog.open();e=2;var d=this.getView();var u=this;var g=this.getView().byId("idSubmitWithDocBtn");if(!this.byId("idAttachmentDlg")){s.load({id:d.getId(),name:"ranpak.wz.rebatelist.fragment.attachmentDlg",controller:this}).then(function(e){d.addDependent(e);e.open();d.byId("idMyRebatesPg").setShowFooter(false);u.resetAttachMdl();if(g){g.setEnabled(false)}u.oBusyDialog.close()})}else{this.byId("idAttachmentDlg").open();this.byId("idMyRebatesPg").setShowFooter(false);this.resetAttachMdl();if(g){g.setEnabled(false)}this.oBusyDialog.close()}}return e},onAttachmentUpload:function(e){var t=e.getSource().oFileUpload.files;var a=this.getOwnerComponent().getModel("oAttachmentMdl");var l=a.getProperty("/results");this.formAttachments(t,a,l)},formAttachments:function(e,t,a){var l="",r="",s="",o="",n=0;for(var d=0;d<e.length;d++){l=e[d].name;s=e[d].size;r=e[d].size/(1024*1024);r=parseFloat(r.toFixed(2));o=l.substring(l.lastIndexOf(".")+1,l.length)||l;o=o.toUpperCase();if(o==="XLSX"||o==="XLS"||o==="CSV"||o==="PNG"||o==="JPEG"||o==="JPG"||o==="PDF"||o==="DOCX"||o==="DOC"||o==="TXT"||o==="PPTX"||o==="PPT"||o==="MSG"||o==="EML"){for(var u=0;u<a.length;u++){if(l===a[u].fileName){i.show(this.oI18n.getText("SAME_FILE_NAME"));return}else{n+=parseFloat(a[u].fileSize.split(" MB")[0])}}n+=r;if(n>50){i.show(this.oI18n.getText("DOC_SIZE_ERROR"))}else{this.updateAttachmentsModel(e[d],t,a,l,s,r,o)}}else{i.show(this.oI18n.getText("SUPPORTED_DOC"))}}},updateAttachmentsModel:function(e,t,a,l,i,r,s){var o=this.getView().byId("idSubmitWithDocBtn");var n=this.getView().byId("idBlkSubmitBtn");var d=new FileReader;d.readAsDataURL(e);d.onloadend=function(e){if(e.target.readyState===FileReader.DONE){var d=e.target.result;var u=d.split(",")[1];a.push({b64Content:u,fileName:l,fileSizeBytes:i,fileSize:r+" MB",fileType:s});t.refresh(true);if(o){o.setEnabled(true)}if(n){n.setEnabled(true)}}}},onSubmitClm:function(){var e=this.validatePayload();if(e===0){r.error(this.oI18n.getText("VALIDATE_PAYLOAD_ERR"))}},onAttachmentDel:function(e){var t=this.getOwnerComponent().getModel("oAttachmentMdl");var a=t.getProperty("/results");var l=e.getSource().getBindingContext("oAttachmentMdl");var i=l.getPath().split("/")[2];a.splice(i,1);t.refresh(true);if(a.length===0){if(this.byId("idSubmitWithDocBtn")){this.byId("idSubmitWithDocBtn").setEnabled(false)}if(this.byId("idBlkSubmitBtn")){this.byId("idBlkSubmitBtn").setEnabled(false)}}},onSubmitClmWithDoc:function(){this.triggerRebateClmSubmit()},onClmWithDocCncl:function(){this.resetAttachMdl();this.byId("idAttachmentDlg").close();this.byId("idMyRebatesPg").setShowFooter(true)},onBulkBtnPress:function(){this.oBusyDialog.open();var e=this.getView();var t=this;if(!this.byId("idBlkRbtClmDlg")){s.load({id:e.getId(),name:"ranpak.wz.rebatelist.fragment.bulkRebateClaimWizard",controller:this}).then(function(a){e.addDependent(a);a.open();t.oBlkRbtClmWiz=e.byId("idBlkRbtClmWiz");t.idDwnldTmpltWizStp=e.byId("idDwnldTmpltWizStp");t.oUpldTmpltWizStp=e.byId("idUpldTmpltWizStp");t.oReviewWizStp=e.byId("idReviewWizStp");t.oAttachUpldWizStp=e.byId("idAttachUpldWizStp");var l=e.byId("idMyRebatesPg");var i=e.byId("idMyRebatesTbl");var r=i.getTable().getSelectedItems();t.onTblMutliDSlct(l,r);t.resetBlkClmWiz();t.oBusyDialog.close()})}else{this.byId("idBlkRbtClmDlg").open();var a=e.byId("idMyRebatesPg");var l=e.byId("idMyRebatesTbl");var i=l.getTable().getSelectedItems();this.onTblMutliDSlct(a,i);this.resetBlkClmWiz();this.oBusyDialog.close()}},resetBlkClmWiz:function(){this.oBlkRbtClmWiz.setCurrentStep(this.idDwnldTmpltWizStp);var e=this.getView().byId("idBlkSubmitBtn");e.setEnabled(false);this.resetAttachMdl()},onBlkCncl:function(){this.resetBlkClmWiz();this.byId("idBlkRbtClmDlg").close()},onDwnldTemplt:function(){var e=this.getAppModulePath()+"/artifacts/Rebate-Claim-Template.xlsx";sap.m.URLHelper.redirect(e,true);this.oBlkRbtClmWiz.setCurrentStep(this.oUpldTmpltWizStp)},onUpldTemplt:function(e){this.oBusyDialog.open();var t=e.getSource().oFileUpload.files[0];this.resetAttachMdl();var a=this.getView().byId("idBlkSubmitBtn");a.setEnabled(false);this.oParseExcel(t)},oParseExcel:function(e){var t=this;var a={},l="",i=e.name,s=i.substring(i.lastIndexOf(".")+1,i.length)||i;s=s.toUpperCase();if(s==="XLSX"){if(e&&window.FileReader){var o=new FileReader;o.onload=function(i){var s=i.target.result;var o=XLSX.read(s,{type:"binary"});o.SheetNames.forEach(function(e){l=o.Sheets[e];a=XLSX.utils.sheet_to_row_object_array(l)});if(a.length>0){t.setExcelDtToTbl(l,a);t.generateTable();t.oBlkRbtClmWiz.setCurrentStep(t.oReviewWizStp);t.oBlkRbtClmWiz.setCurrentStep(t.oAttachUpldWizStp);t.upldTmpltToAttachMdl(e)}else{r.error(t.oI18n.getText("UPLOAD_FILE_EMPTY"));t.oBlkRbtClmWiz.setCurrentStep(t.oUpldTmpltWizStp);t.oBusyDialog.close()}};o.readAsBinaryString(e)}}else{r.error(this.oI18n.getText("UNSUPPORTED_FILE_TYPE"));this.oBusyDialog.close()}},upldTmpltToAttachMdl:function(e){var t=this;var a,l,i,r;a=e.name;l=e.size;i=e.size/(1024*1024);i=parseFloat(i.toFixed(2));r=a.substring(a.lastIndexOf(".")+1,a.length)||a;r=r.toUpperCase();var s=this.getOwnerComponent().getModel("oAttachmentMdl");var o=s.getProperty("/results");var n=new FileReader;n.readAsDataURL(e);n.onloadend=function(e){if(e.target.readyState===FileReader.DONE){var n=e.target.result;var d=n.split(",")[1];o.push({b64Content:d,fileName:a,fileSizeBytes:l,fileSize:i+" MB",fileType:r});s.refresh(true);t.oBusyDialog.close()}}},setExcelDtToTbl:function(e,t){const a=[];const l=XLSX.utils.decode_range(e["!ref"]).e.c+1;for(let t=0;t<l;++t){if(e[XLSX.utils.encode_col(t)+1]){a[t]=e[XLSX.utils.encode_col(t)+1].v}}this.oBlkUpldMdl.setProperty("/columns",a);this.oBlkUpldMdl.setProperty("/rows",t)},generateTblTmplt:function(e){var t=this;var a="";var l=new Date;var i=new Date((new Date).setDate(l.getDate()-60));if(e){if(e.toUpperCase().indexOf("DATE")!==-1){a=new u({value:{path:"oBlkUpldMdl>"+e,formatter:this.validateDateFldBlk},displayFormat:"YYYY/MM/dd",valueFormat:"YYYY-MM-dd",change:function(e){this.setValueState("None");if(e.getSource().getBindingContext("oBlkUpldMdl")){e.getSource().getBindingContext("oBlkUpldMdl").getObject()[e.getSource().getBindingInfo("value").parts[0].path]=e.getSource().getValue()}},maxDate:l,minDate:i});return a}else if(e.toUpperCase().indexOf("#")!==-1||e.toUpperCase().indexOf("NUMBER")!==-1){a=new g({value:{path:"oBlkUpldMdl>"+e,formatter:this.validateAlphaNumFldBlk},change:function(e){var a=t.validateAlphaNumFld(e);if(a){e.getSource().setValueState("None")}else{e.getSource().setValueState("Error");e.getSource().setValue(null)}if(e.getSource().getBindingContext("oBlkUpldMdl")){e.getSource().getBindingContext("oBlkUpldMdl").getObject()[e.getSource().getBindingInfo("value").parts[0].path]=e.getSource().getValue()}}});return a}else if(e.toUpperCase().indexOf("AMOUNT")!==-1||e.toUpperCase().indexOf("PRICE")!==-1){a=new g({value:{path:"oBlkUpldMdl>"+e,formatter:this.validateAmntFldBlk},change:function(e){var a=e.getSource().getValue();var l=c.getCurrencyInstance({currencyCode:false,decimals:2});var i=t.validateNumberFld(e);if(i){e.getSource().setValueState("None");e.getSource().setValue(l.format(a))}else{e.getSource().setValueState("Error");e.getSource().setValue(null)}if(e.getSource().getBindingContext("oBlkUpldMdl")){e.getSource().getBindingContext("oBlkUpldMdl").getObject()[e.getSource().getBindingInfo("value").parts[0].path]=e.getSource().getValue()}}});return a}else if(e.toUpperCase().indexOf("NAME")!==-1){a=new g({value:{path:"oBlkUpldMdl>"+e},change:function(e){var t=e.getSource().getValue();if(e.getSource().getBindingContext("oBlkUpldMdl")){e.getSource().getBindingContext("oBlkUpldMdl").getObject()[e.getSource().getBindingInfo("value").parts[0].path]=t}}});return a}else{a=new g({value:{path:"oBlkUpldMdl>"+e,formatter:this.validateAlphaNumFldBlk},change:function(e){var a=t.validateAlphaNumFld(e);if(a){e.getSource().setValueState("None")}else{e.getSource().setValueState("Error");e.getSource().setValue(null)}if(e.getSource().getBindingContext("oBlkUpldMdl")){e.getSource().getBindingContext("oBlkUpldMdl").getObject()[e.getSource().getBindingInfo("value").parts[0].path]=e.getSource().getValue()}}});return a}}else{a=new g({value:{path:"oBlkUpldMdl>"+e,formatter:this.validateAlphaNumFldBlk},change:function(e){var a=t.validateAlphaNumFld(e);if(a){e.getSource().setValueState("None")}else{e.getSource().setValueState("Error");e.getSource().setValue(null)}if(e.getSource().getBindingContext("oBlkUpldMdl")){e.getSource().getBindingContext("oBlkUpldMdl").getObject()[e.getSource().getBindingInfo("value").parts[0].path]=e.getSource().getValue()}}});return a}},generateTable:function(){var e=this;var t=this.getView().byId("idBlkUpldTbl");t.bindColumns("oBlkUpldMdl>/columns",function(t,a){var l=a.getObject();if(l&&l.indexOf("/")!==-1){l=l.split("/")[0]}var i=e.generateTblTmplt(l);return new n({label:l,template:i,width:"12rem",tooltip:l,sortProperty:l,filterProperty:l})});t.bindRows("oBlkUpldMdl>/rows")}})});
//# sourceMappingURL=ListView.controller.js.map